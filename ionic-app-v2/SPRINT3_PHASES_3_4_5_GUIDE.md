# üöÄ SPRINT 3 - PHASES 3, 4 & 5 - GUIDE COMPLET

## Date : 11 octobre 2025

---

## ‚úÖ PHASE 3 : CACHE INTELLIGENT DES IMAGES

### Fichier Cr√©√©
**`src/services/imageCacheService.ts`** (600+ lignes)

### Fonctionnalit√©s Impl√©ment√©es

#### 1. T√©l√©chargement et Cache
- ‚úÖ T√©l√©chargement images avec progress callback
- ‚úÖ Stockage sur Filesystem (Capacitor natif)
- ‚úÖ Fallback localStorage pour web
- ‚úÖ Queue de t√©l√©chargement avec priorit√©s (high/medium/low)

#### 2. Compression Automatique
- ‚úÖ Canvas API pour redimensionnement
- ‚úÖ Max dimensions : 1920x1080
- ‚úÖ Qualit√© JPEG : 0.8 (80%)
- ‚úÖ Logs compression avant/apr√®s

#### 3. Lazy Loading
- ‚úÖ IntersectionObserver avec rootMargin: 50px
- ‚úÖ Chargement juste avant affichage
- ‚úÖ Unobserve automatique apr√®s chargement

#### 4. Nettoyage Automatique
- ‚úÖ Suppression images > 30 jours
- ‚úÖ Nettoyage si cache > 200 MB
- ‚úÖ Conservation priorit√© "high"
- ‚úÖ Tri par lastAccessedAt

#### 5. Statistiques
- ‚úÖ Total images cached
- ‚úÖ Taille totale et par priorit√©
- ‚úÖ Images compress√©es vs non compress√©es
- ‚úÖ Formatage taille en KB/MB/GB

### API Principale

```typescript
import { imageCacheService } from './services/imageCacheService';

// Initialiser (auto au d√©marrage)
await imageCacheService.initialize();

// Cacher une image avec progress
await imageCacheService.cacheImage(
  'https://example.com/image.jpg',
  'high', // priority
  true,   // compress
  (progress) => {
    console.log(`${progress.percentage}%`);
  }
);

// Pr√©charger plusieurs images
await imageCacheService.precacheImages(
  ['url1.jpg', 'url2.jpg'],
  'high',
  (current, total) => console.log(`${current}/${total}`)
);

// Obtenir image (cached ou t√©l√©charger)
const imageUrl = await imageCacheService.getImage('url.jpg');

// Lazy loading avec IntersectionObserver
const observer = imageCacheService.createLazyLoader((entry) => {
  const img = entry.target as HTMLImageElement;
  const url = img.dataset.src;
  if (url) {
    imageCacheService.getImage(url).then(cachedUrl => {
      img.src = cachedUrl;
    });
  }
});
observer.observe(imageElement);

// Statistiques
const stats = await imageCacheService.getStats();
console.log(`${stats.totalImages} images, ${imageCacheService.formatBytes(stats.totalSize)}`);

// Vider cache
await imageCacheService.clearCache();
```

### Configuration
```typescript
const CACHE_DIR = 'images_cache';
const MAX_CACHE_SIZE = 200 * 1024 * 1024; // 200 MB
const MAX_AGE_DAYS = 30;
const COMPRESSION_QUALITY = 0.8;
const MAX_IMAGE_WIDTH = 1920;
const MAX_IMAGE_HEIGHT = 1080;
```

---

## ‚úÖ PHASE 4 : CACHE AUDIO (INDEXEDDB)

### Fichier Cr√©√©
**`src/services/audioCacheService.ts`** (600+ lignes)

### Fonctionnalit√©s Impl√©ment√©es

#### 1. Stockage IndexedDB
- ‚úÖ Database : `audioguide_cache`
- ‚úÖ Object Store : `audios` avec keyPath: 'id'
- ‚úÖ Index : attractionId, language, downloadedAt, lastPlayedAt
- ‚úÖ Stockage Blob audio (quota ~100 MB)

#### 2. T√©l√©chargement avec Progress
- ‚úÖ Fetch avec AbortController
- ‚úÖ Progress callback d√©taill√© (loaded, total, percentage, speed, timeRemaining)
- ‚úÖ Chunked reading avec Reader
- ‚úÖ Calcul vitesse (bytes/sec)

#### 3. File d'Attente
- ‚úÖ Queue avec priorit√©s (high/medium/low)
- ‚úÖ Tri automatique par priorit√©
- ‚úÖ Traitement s√©quentiel (500ms entre downloads)
- ‚úÖ Annulation en cours (AbortController)

#### 4. Mode Offline
- ‚úÖ Object URL depuis Blob
- ‚úÖ Fallback streaming si pas en cache
- ‚úÖ D√©tection automatique cached/streaming
- ‚úÖ Mise √† jour lastPlayedAt √† chaque lecture

#### 5. Gestion Cache
- ‚úÖ Nettoyage automatique (quota 70%)
- ‚úÖ Tri par lastPlayedAt
- ‚úÖ Conservation priorit√© "high"
- ‚úÖ Vider cache complet

### API Principale

```typescript
import { audioCacheService } from './services/audioCacheService';

// T√©l√©charger un audio avec progress
await audioCacheService.downloadAudio(
  'audio123',
  'https://example.com/audio.mp3',
  'attraction456',
  'fr',
  'high',
  (progress) => {
    console.log(`${progress.percentage.toFixed(1)}%`);
    console.log(`Speed: ${audioCacheService.formatBytes(progress.speed)}/s`);
    console.log(`Remaining: ${progress.timeRemaining.toFixed(0)}s`);
  }
);

// Ajouter √† la file d'attente
audioCacheService.addToQueue({
  audioId: 'audio123',
  url: 'https://example.com/audio.mp3',
  attractionId: 'attraction456',
  language: 'fr',
  priority: 'medium',
});

// Obtenir URL pour lecture
const audioUrl = await audioCacheService.getAudioUrl('audio123', 'fallback-url.mp3');
const audio = new Audio(audioUrl);
audio.play();

// V√©rifier si t√©l√©charg√©
const isDownloaded = await audioCacheService.isDownloaded('audio123');

// Annuler t√©l√©chargement
audioCacheService.cancelDownload('audio123');

// Obtenir audios d'une attraction
const audios = await audioCacheService.getAudiosByAttraction('attraction456');

// Statistiques
const stats = await audioCacheService.getStats();
console.log(`${stats.totalAudios} audios, ${audioCacheService.formatBytes(stats.totalSize)}`);
console.log(`Used: ${stats.usedPercentage.toFixed(1)}%`);

// Vider cache
await audioCacheService.clearCache();
```

### Configuration
```typescript
const DB_NAME = 'audioguide_cache';
const DB_VERSION = 1;
const STORE_NAME = 'audios';
const MAX_CACHE_SIZE = 100 * 1024 * 1024; // 100 MB
```

---

## ‚úÖ PHASE 5 : BACKGROUND SYNC

### Fichier Cr√©√©
**`src/services/backgroundSyncService.ts`** (600+ lignes)

### Fonctionnalit√©s Impl√©ment√©es

#### 1. File de Synchronisation
- ‚úÖ localStorage persistence (`backgroundSyncQueue`)
- ‚úÖ 5 types : favorite, unfavorite, review, rating, stats
- ‚úÖ Priorit√©s : high/medium/low
- ‚úÖ Tri automatique par priorit√©

#### 2. D√©tection R√©seau
- ‚úÖ Capacitor Network plugin
- ‚úÖ Event listener `networkStatusChange`
- ‚úÖ Auto-sync au retour online
- ‚úÖ Fallback `navigator.onLine`

#### 3. Retry avec Exponential Backoff
- ‚úÖ Max 5 tentatives
- ‚úÖ D√©lai initial : 1 seconde
- ‚úÖ D√©lai max : 1 minute
- ‚úÖ Formule : delay = 1000 * 2^attempts

#### 4. Synchronisation P√©riodique
- ‚úÖ Interval : 30 secondes
- ‚úÖ Condition : online + queue non vide + pas de sync en cours
- ‚úÖ Stop/start automatique

#### 5. API Endpoints (TODO)
- ‚è≥ POST /favorites (√† impl√©menter backend)
- ‚è≥ DELETE /favorites/:id
- ‚è≥ POST /reviews
- ‚è≥ POST /ratings
- ‚è≥ PATCH /users/:id/stats

### API Principale

```typescript
import { backgroundSyncService } from './services/backgroundSyncService';

// Ajouter favori (sync auto si online)
await backgroundSyncService.addFavorite('attraction123', 'user456');

// Retirer favori
await backgroundSyncService.removeFavorite('attraction123', 'user456');

// Ajouter review
await backgroundSyncService.addReview(
  'attraction123',
  'user456',
  5, // rating
  'Excellent !' // comment
);

// Ajouter note
await backgroundSyncService.addRating('attraction123', 'user456', 4);

// Ajouter statistiques
await backgroundSyncService.addStats('user456', {
  audioPlayed: 10,
  attractionsVisited: 5,
  totalPlayTime: 3600,
});

// Synchroniser manuellement
const results = await backgroundSyncService.sync();
console.log(`Synced ${results.length} items`);

// Statistiques
const stats = backgroundSyncService.getStats();
console.log(`Pending: ${stats.totalPending}`);
console.log(`By type:`, stats.byType);
console.log(`Failed attempts: ${stats.failedAttempts}`);

// Vider la queue
backgroundSyncService.clearQueue();

// Retirer un √©l√©ment
backgroundSyncService.removeItem('favorite_123_1234567890');
```

### Configuration
```typescript
const SYNC_QUEUE_KEY = 'backgroundSyncQueue';
const MAX_RETRY_ATTEMPTS = 5;
const INITIAL_RETRY_DELAY = 1000; // 1 seconde
const MAX_RETRY_DELAY = 60000; // 1 minute
const SYNC_INTERVAL = 30000; // 30 secondes
```

---

## üìä INT√âGRATION DANS L'APP

### 1. Initialisation (App.tsx)

```typescript
import { imageCacheService } from './services/imageCacheService';
import { audioCacheService } from './services/audioCacheService';
import { backgroundSyncService } from './services/backgroundSyncService';

useEffect(() => {
  // Services auto-initialis√©s au d√©marrage
  console.log('‚úÖ Cache services initialized');
}, []);
```

### 2. Utilisation dans Home.tsx

```typescript
// Pr√©charger images prioritaires
useEffect(() => {
  const imageUrls = attractions.map(a => a.imageUrl);
  imageCacheService.precacheImages(imageUrls, 'high');
}, [attractions]);

// Lazy loading images
const imageRef = useRef<HTMLImageElement>(null);
useEffect(() => {
  if (imageRef.current) {
    const observer = imageCacheService.createLazyLoader((entry) => {
      const img = entry.target as HTMLImageElement;
      const url = img.dataset.src;
      if (url) {
        imageCacheService.getImage(url).then(cachedUrl => {
          img.src = cachedUrl;
        });
      }
    });
    observer.observe(imageRef.current);
    return () => observer.disconnect();
  }
}, []);
```

### 3. Utilisation dans AttractionDetail.tsx

```typescript
// T√©l√©charger audio
const [downloadProgress, setDownloadProgress] = useState(0);

const handleDownloadAudio = async (audioId: string, url: string) => {
  await audioCacheService.downloadAudio(
    audioId,
    url,
    attractionId,
    'fr',
    'high',
    (progress) => setDownloadProgress(progress.percentage)
  );
};

// V√©rifier si audio t√©l√©charg√©
const [isDownloaded, setIsDownloaded] = useState(false);
useEffect(() => {
  audioCacheService.isDownloaded(audioId).then(setIsDownloaded);
}, [audioId]);

// Lecture audio
const playAudio = async () => {
  const audioUrl = await audioCacheService.getAudioUrl(audioId, originalUrl);
  const audio = new Audio(audioUrl);
  audio.play();
};
```

### 4. Utilisation dans Favorites.tsx

```typescript
// Ajouter favori (sync background)
const handleAddFavorite = async (attractionId: string) => {
  // Mise √† jour locale imm√©diate
  setFavorites([...favorites, attractionId]);
  localStorage.setItem('favorites', JSON.stringify([...favorites, attractionId]));
  
  // Sync background
  await backgroundSyncService.addFavorite(attractionId, userId);
};

// Retirer favori
const handleRemoveFavorite = async (attractionId: string) => {
  const updated = favorites.filter(id => id !== attractionId);
  setFavorites(updated);
  localStorage.setItem('favorites', JSON.stringify(updated));
  
  await backgroundSyncService.removeFavorite(attractionId, userId);
};
```

### 5. Statistiques dans Profile.tsx

```typescript
// Statistiques cache
const [cacheStats, setCacheStats] = useState({
  images: { totalImages: 0, totalSize: 0 },
  audios: { totalAudios: 0, totalSize: 0 },
  sync: { totalPending: 0, byType: {} },
});

useEffect(() => {
  Promise.all([
    imageCacheService.getStats(),
    audioCacheService.getStats(),
  ]).then(([images, audios]) => {
    setCacheStats({
      images,
      audios,
      sync: backgroundSyncService.getStats(),
    });
  });
}, []);

// UI
<IonCard>
  <IonCardHeader>Cache Images</IonCardHeader>
  <IonCardContent>
    {cacheStats.images.totalImages} images
    ({imageCacheService.formatBytes(cacheStats.images.totalSize)})
  </IonCardContent>
</IonCard>

<IonCard>
  <IonCardHeader>Cache Audio</IonCardHeader>
  <IonCardContent>
    {cacheStats.audios.totalAudios} audios
    ({audioCacheService.formatBytes(cacheStats.audios.totalSize)})
    <IonProgressBar value={cacheStats.audios.usedPercentage / 100} />
  </IonCardContent>
</IonCard>

<IonCard>
  <IonCardHeader>Synchronisation</IonCardHeader>
  <IonCardContent>
    {cacheStats.sync.totalPending} en attente
  </IonCardContent>
</IonCard>
```

---

## üß™ TESTS

### Test Phase 3 : Images

```typescript
// Test t√©l√©chargement
const url = 'https://picsum.photos/800/600';
await imageCacheService.cacheImage(url, 'high', true, (progress) => {
  console.log(`Progress: ${progress.percentage.toFixed(1)}%`);
});

// Test lazy loading
const img = document.createElement('img');
img.dataset.src = url;
const observer = imageCacheService.createLazyLoader((entry) => {
  const img = entry.target as HTMLImageElement;
  imageCacheService.getImage(img.dataset.src!).then(cachedUrl => {
    img.src = cachedUrl;
  });
});
observer.observe(img);

// Test stats
const stats = await imageCacheService.getStats();
console.log('Image Cache Stats:', stats);
```

### Test Phase 4 : Audio

```typescript
// Test t√©l√©chargement
const audioUrl = 'https://example.com/audio.mp3';
await audioCacheService.downloadAudio(
  'test-audio',
  audioUrl,
  'test-attraction',
  'fr',
  'high',
  (progress) => {
    console.log(`${progress.percentage.toFixed(1)}% - ${progress.speed} bytes/s - ${progress.timeRemaining}s remaining`);
  }
);

// Test lecture
const url = await audioCacheService.getAudioUrl('test-audio', audioUrl);
const audio = new Audio(url);
audio.play();

// Test stats
const stats = await audioCacheService.getStats();
console.log('Audio Cache Stats:', stats);
```

### Test Phase 5 : Background Sync

```typescript
// Test ajout favori
await backgroundSyncService.addFavorite('attraction123', 'user456');

// Test ajout review
await backgroundSyncService.addReview('attraction123', 'user456', 5, 'Excellent !');

// Simuler offline
window.dispatchEvent(new Event('offline'));
console.log('Offline mode');

// Ajouter items pendant offline
await backgroundSyncService.addRating('attraction456', 'user456', 4);

// Check queue
const stats = backgroundSyncService.getStats();
console.log('Sync Queue:', stats);

// Simuler retour online
window.dispatchEvent(new Event('online'));
// Auto-sync se d√©clenche

// Sync manuel
const results = await backgroundSyncService.sync();
console.log('Sync Results:', results);
```

---

## üìö DOCUMENTATION TECHNIQUE

### Architecture G√©n√©rale

```
ionic-app-v2/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ apiConfig.ts (‚úÖ API configuration dynamique)
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ imageCacheService.ts (‚úÖ Phase 3)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audioCacheService.ts (‚úÖ Phase 4)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backgroundSyncService.ts (‚úÖ Phase 5)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apiClient.ts (‚úÖ Updated avec apiConfig)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serviceWorkerService.ts (Phase 2)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ geolocationService.ts (Phase 1)
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

### D√©pendances Utilis√©es

- **Capacitor Filesystem** : Stockage images (natif)
- **Capacitor Network** : D√©tection online/offline
- **IndexedDB API** : Stockage audios (web + natif)
- **Canvas API** : Compression images
- **IntersectionObserver** : Lazy loading images
- **Fetch API** : T√©l√©chargements avec progress

---

## üéØ TODO BACKEND

### Endpoints √† Impl√©menter

```typescript
// Favorites
POST   /api/favorites           { attractionId, userId }
DELETE /api/favorites/:id       { userId }
GET    /api/favorites/:userId

// Reviews
POST   /api/reviews             { attractionId, userId, rating, comment }
GET    /api/reviews/:attractionId

// Ratings
POST   /api/ratings             { attractionId, userId, rating }
GET    /api/ratings/:attractionId

// User Stats
PATCH  /api/users/:id/stats     { audioPlayed, attractionsVisited, totalPlayTime, ... }
GET    /api/users/:id/stats
```

### Mod√®les MongoDB

```typescript
// Favorite
{
  _id: ObjectId,
  userId: String,
  attractionId: String,
  createdAt: Date
}

// Review
{
  _id: ObjectId,
  userId: String,
  attractionId: String,
  rating: Number (1-5),
  comment: String,
  createdAt: Date,
  updatedAt: Date
}

// UserStats
{
  _id: ObjectId,
  userId: String,
  audioPlayed: Number,
  attractionsVisited: Number,
  totalPlayTime: Number (seconds),
  favoritesCount: Number,
  reviewsCount: Number,
  lastActive: Date
}
```

---

## üìä M√âTRIQUES PHASES 3, 4 & 5

### Code Produit
- **Phase 3 (Images)** : 600+ lignes
- **Phase 4 (Audio)** : 600+ lignes
- **Phase 5 (Background Sync)** : 600+ lignes
- **API Config** : 200+ lignes
- **Total** : 2000+ lignes

### Fichiers Cr√©√©s
- `src/config/apiConfig.ts`
- `src/services/imageCacheService.ts`
- `src/services/audioCacheService.ts`
- `src/services/backgroundSyncService.ts`
- **Total** : 4 fichiers

### Fonctionnalit√©s
- **Phase 3** : 5 features (download, compress, lazy load, cleanup, stats)
- **Phase 4** : 5 features (IndexedDB, download, queue, offline, cleanup)
- **Phase 5** : 5 features (queue, retry, network, periodic, stats)
- **Total** : 15 features

---

## ‚úÖ PROCHAINES √âTAPES

### 1. Configuration Backend (URGENT)
- [ ] Ex√©cuter `allow-port-5000.ps1` en Admin
- [ ] V√©rifier IP : `ipconfig` (192.168.1.9)
- [ ] Lancer backend : `npm run dev`
- [ ] Tester health check depuis device

### 2. Installation Android
- [ ] Ouvrir Android Studio
- [ ] Clean + Rebuild Project
- [ ] Run 'app' sur device

### 3. Tests Device
- [ ] Backend connectivity
- [ ] Geofencing (Phase 1)
- [ ] Service Worker web (Phase 2)
- [ ] Cache images (Phase 3)
- [ ] Cache audio (Phase 4)
- [ ] Background sync (Phase 5)

### 4. Impl√©mentation Backend API
- [ ] Endpoints favorites
- [ ] Endpoints reviews
- [ ] Endpoints ratings
- [ ] Endpoints user stats
- [ ] Tests API

---

üéâ **SPRINT 3 PHASES 3, 4 & 5 : CODE COMPL√âT√â !**
‚úÖ **2000+ lignes produites**
‚úÖ **15 fonctionnalit√©s impl√©ment√©es**
üöÄ **Pr√™t pour int√©gration et tests !**
